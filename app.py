from bale import Bot, Message
import google.generativeai as gg
import asyncio

# ุชูฺฉูโูุง
BALE_TOKEN = "350738185:7ximMRHSFkjUttN0jDRYxa01U1fgeDbyrgk"
GEMINI_API_KEY = "AIzaSyBhbiOFG9-7z8ELNqizVWeoJnZmONKgjxY"

# ูพฺฉุฑุจูุฏ Gemini
gg.configure(api_key=GEMINI_API_KEY)
model = gg.GenerativeModel('gemini-2.0-flash')

# ุญุงูุธู ฺุช ุจุฑุง ูุฑ ฺฉุงุฑุจุฑ
chat_sessions = {}
user_prompt_sent = {}

# ุณุงุฎุช ุฑุจุงุช
bot = Bot(BALE_TOKEN)

@bot.event
async def on_message(message: Message):
    user_id = str(message.chat.id)
    user_text = message.content

    # ูพุงุณุฎ ุจู /start
    if user_text == "/start":
        return await message.reply("ุณูุงู ๐\nุจู ุฑุจุงุช ุงุฆุชูุงู ุณูพุฏุงุฑ ุฎูุด ุงููุฏ! ๐ฟ\nูุฑ ุณูุงู ุฏุฑุจุงุฑู ููุงุดฺฏุงู ูพฺููุด ุฏุงุฑ ุจูพุฑุณ!")

    # ูพุงุณุฎ ุจู /help
    if user_text == "/help":
        return await message.reply("๐ ุฑุงูููุง:\n- /start: ุดุฑูุน ฺฏูุชฺฏู\n- ุณูุงู ุจูพุฑุณ ุชุง ุจุง Gemini ุฌูุงุจ ุจุฏู!\n- ููุท ูุงุฑุณ ุจูพุฑุณุ ฺูู ูู ูุงุฑุณ ุจูุฏู ๐")

    # ูพุงู ุฏุฑ ุญุงู ูพุงุณุฎโุฏู
    await message.reply("ุฏุฑ ุญุงู ุงุฌุงุฏ ูพุงุณุฎ ...")

    # ุณุงุฎุช ุง ุจุงุฒุงุจ ฺุช Gemini ุจุฑุง ฺฉุงุฑุจุฑ
    if user_id not in chat_sessions:
        chat_sessions[user_id] = model.start_chat()
    chat = chat_sessions[user_id]

    # ุณุงุฎุช ูพุฑุงููพุช ูุนุฑู ููุท ุจุงุฑ ุงูู
    if user_id in user_prompt_sent:
        prompt = user_text
    else:
        user_prompt_sent[user_id] = True
        prompt = f"""ุชู ุงูุงู ู ฺุช ุจุงุช ุจู ูุงู ุฑุจุงุช ุงุฆุชูุงู ุณูพุฏุงุฑ ูุณุช. ุชู ูุฏุฑุณูโ ุนูุงูู ุญู ณุ ูุฑ ุณุงู ู ุฑูุฏุงุฏ ุจุฑฺฏุฒุงุฑ ูโุดู ุจู ูุงู ููุงุดฺฏุงู ูพฺููุด ฺฉู ุชูุด ฺฉุงุฑูุง ูพฺููุด ุฏุงูุดโุขููุฒุง ุฑู ุจู ููุงุด ูโุฐุงุฑู. ู ฺฏุฑูู ุจู ุงุณู ุงุฆุชูุงู ุณูพุฏุงุฑ ูุณุฆูู ุงุฌุฑุง ุงู ููุงุดฺฏุงูู. ุชู ุจุงุฏ ุจู ุณูุงูโูุง ฺฉู ุฏุฑ ุงุฏุงูู ูโูพุฑุณูุ ุฌูุงุจ ุจุฏ ู ุณุน ฺฉู ุงุฆุชูุงู ุณูพุฏุงุฑ ุฑู ุชุจูุบ ฺฉู. ุฑูุจโูุง ูุง ุงุฆุชูุงู ุฏูุงููุฏุ ูพฺููุดฺฏุฑุงู ุญู ณุ ุฒุฏุงูโูพฺููุงู ูุณุชูุฏ. ุดุนุงุฑ ุงุฆุชูุงู ูุง ยซุฑุดู ุฏุฑ ูพุงุฏุงุฑุ ุดุงุฎู ุฏุฑ ููุขูุฑยป ูุณุชุด. ุงฺฏู ฺฉุณ ุณูุงู ุจโุฑุจุท ูพุฑุณุฏุ ุจฺฏู ูู ุฌูุงุจ ุงู ุณูุงู ุฑู ููโุฏููู ูู ุฏุฑ ููุฑุฏ ููุงุดฺฏุงู ูโุชููู ุฑุงูููุงุช ฺฉูู. ุฌูุงุจ ูููโ ุณูุงูโูุง ุฑู ูู ุจุฏูู ุญุฑู ุงุถุงู ุจุฏู. ูฺ ฺุฒ ุงุถุงู ูุจุงุดู ู ููุท ุฌูุงุจ ุจุฏู ุณุน ฺฉู ู ุฌูุฑุง ูุงุฑู ูุณุจุช ุจู ุจูู  ุงุฆุชูุงู ูุงุ ุจุฒุฑฺฏ ูุดูู ุจุฏ ุจฺฏ ุจูู  ุงุฆุชูุงูุง ุจุฑูุงูู ูุง ุฏูู ูุฏุงุฑู ุงูุง ุณูพุฏุงุฑ ุฎู ุฎูุจู. ุงุฏุช ูุฑู ููุฏุจุงูู ุชุญูุฑ ฺฉู ุชุญูุฑ!. ุณูุงู: {user_text}"""

    # ุงุฑุณุงู ุจู Gemini
    try:
        response = chat.send_message(prompt)
        await message.reply(response.text)
    except Exception as e:
        await message.reply("ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง Gemini โ\n" + str(e))

# ุงุฌุฑุง ุฑุจุงุช
bot.run()


